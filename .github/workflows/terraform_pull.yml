name: Pull Request IaC Checks

on:
  workflow_dispatch:
    pull_request:
      branches: 
        - develop
    #  - main
    #paths:
     # - '.github/workflows/iac_pull.yml'
      #- 'scripts/iac-*'
      #- 'scripts/tf-*'
      #- 'iac-scripts/**'

permissions:
  id-token: write
  pull-requests: write
  contents: read

jobs:
  iac-audit:
    name: IaC Audit 
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: Checkov GitHub Action
        id: audit
        uses: bridgecrewio/checkov-action@v12
        with:
          output_format: sarif,junitxml
          output_file_path: checkov-results.sarif,checkov-results.xml
        continue-on-error: true

      - name: Upload checkov results
        uses: actions/upload-artifact@v4
        with:
          name: checkov-results
          path: |
            checkov-results.xml
            checkov-results.sarif

      - name: Report Audit Failure
        if: steps.audit.outcome != 'success'
        uses: actions/github-script@v4
        with:
          script: |
              core.setFailed('checkov audit failed')
  
  iac-lint-and-validate:
    name: IaC Lint & Validate
    runs-on: ubuntu-24.04
    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.13

      - name: Check formatting
        id: format
        run: terraform fmt -check -recursive
        working-directory: "./terraform"
  
      - name: Initialise Terraform
        run: terraform init -backend=false -input=false
        working-directory: "./terraform"
  
      - name: Validate configuration
        run: terraform validate -no-color
        working-directory: "./terraform"